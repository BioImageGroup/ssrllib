# ============================================================================ #
# ================================ CONFIG FILE =============================== #
# ============================================================================ #

# --------------------------------------------------------------------- #
# -------------------------------- DATA ------------------------------- #
# --------------------------------------------------------------------- #

# ___ base ___ #
dataset_properties: &dataset_properties
  name: ClassificationROIDataset
  data_dir: /home/nicola/data/meso
  type: ndpi
  size: &size 128

in_channels: &data_channels 3

# ___ dataset ___ #
dataset: &dataset
  train:
    <<: *dataset_properties
    split:
      - 0
      - 0.12
    splitting: stratified
  val:
    <<: *dataset_properties
    split:
      - 0.6
      - 0.8
    splitting: stratified
  test:
    <<: *dataset_properties
    split:
      - 0.8
      - 1
    splitting: stratified
  pred:
    <<: *dataset_properties
    split:
      - 0
      - 1
    splitting: stratified

# ___ datamodule ___ #
datamodule:
  dataset_hparams: *dataset
  workers:
    train: 12
    val: 12
    test: 12
    pred: 12
  batch_sizes:
    train: 32
    val: 32
    test: 32
    pred: 1

# ___ transforms ___ # (Optional)
# transforms:
#   - name: Rotate90
#     prob: 0.5
#   - name: Flip
#     prob: 0.5
#     dim: 0
#   - name: Flip
#     prob: 0.5
#     dim: 1
#   - name: ContrastAdjust
#     adj: 0.1
#   - name: AddNoise
#     sigma_max: 0.1


# --------------------------------------------------------------------- #
# --------------------------- OPTIMIZATION ---------------------------- #
# --------------------------------------------------------------------- #

# ___ optimizer ___ #
optimizer: &optimizer
  name: Adam
  lr: 1.0e-05

# ___ scheduler ___ #
scheduler: &scheduler
  name: ReduceLROnPlateau
  monitor: val/Accuracy
  patience: 5
  factor: 0.5
  mode: max

# scheduler: &scheduler
#   name:  ExponentialLR
#   gamma: 0.9

# ___ loss ___ #
loss: &loss
  name: CELoss

# ___ metric ___ #
metric: &metric
  name: Accuracy


# --------------------------------------------------------------------- #
# -------------------------- LIGHTNING MODEL -------------------------- #
# --------------------------------------------------------------------- #
# ___ resnet configs ___ #
resnet_18: &res18_layers
  - 2
  - 2
  - 2
  - 2
resnet_34: &res34_layers
  - 3
  - 4
  - 6
  - 3

# ___ backbone ___ #
backbone_params: &backbone
  name: ResNet
  block: BasicBlock
  layers:
    - 2
    - 2
    - 2
    - 2
  global_avg_pool: True

# ___ head ___ #
head_params: &head
  name: LinearHead
  in_features: 512
  task_classes: 2

# ___ model ___ #
model:
  name: SelfSupervisedModule
  backbone_hparams: *backbone
  head_hparams: *head
  optimizer_hparams: *optimizer
  scheduler_hparams: *scheduler
  loss_hparams: *loss
  metric_hparams: *metric
  input_shape:
    - *data_channels
    - *size
    - *size

# ___ load pretrained ___ # (Optional)
pretrained:
  pretrained_model: /home/nicola/Documents/remote_pycharm_projects/ssrllib/logs/meso_pretext_autoencoding/lightning_logs/version_1/checkpoints/epoch=44-step=989.ckpt
  drop_head: True
  freeze_backbone: True


# --------------------------------------------------------------------- #
# ------------------------- RUN CONFIGURATION ------------------------- #
# --------------------------------------------------------------------- #

# ___ trainer ___ #

trainer:
  max_epochs: 100
  gpus: 1
  accelerator: gpu
  flush_logs_every_n_steps: 1
  log_every_n_steps: 1
  progress_bar_refresh_rate: 1


# --------------------------------------------------------------------- #
# ------------------------- PREDICTION CONFIG ------------------------- #
# --------------------------------------------------------------------- #

pred:
  test_size: 0.4
  train_size: 0.1 # 60% of data (we consider this full supervision)

param_grid:
  classifier__kernel: 
    - rbf
    - linear
  classifier__C:
    - 1
    - 10
    - 100
    - 1000
  downsampler__sampling_strategy:
    - majority
    - auto
  downsampler__n_neighbors:
    - 1
    - 2 
    - 3

seed: 0

